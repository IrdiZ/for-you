<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Save Obi ğŸˆâ€â¬›ğŸ’•</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Poppins:wght@300;400;600&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  min-height: 100vh;
  background: linear-gradient(135deg, #0a0015 0%, #1a0030 30%, #2d1b4e 60%, #1a0030 100%);
  font-family: 'Poppins', sans-serif;
  overflow-x: hidden; color: #fff;
}

/* ===== Background ===== */
.bg-hearts {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 0; overflow: hidden;
}
.bg-heart {
  position: absolute; font-size: 20px; opacity: 0.12;
  animation: floatUp linear infinite;
}
@keyframes floatUp {
  0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
  10% { opacity: 0.12; } 90% { opacity: 0.12; }
  100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
}

/* ===== Screens ===== */
.screen {
  display: none; flex-direction: column; align-items: center;
  justify-content: center; min-height: 100vh; padding: 20px;
  position: relative; z-index: 1;
}
.screen.active { display: flex; }

/* ===== Typewriter ===== */
.story-container {
  max-width: 520px; width: 100%; text-align: center;
}
.story-scene {
  font-size: 80px; margin-bottom: 20px;
  filter: drop-shadow(0 0 25px rgba(200,150,255,0.4));
}
.story-text {
  font-family: 'Crimson Text', serif; font-size: 1.25em;
  line-height: 1.9; opacity: 0.9; min-height: 120px;
  background: rgba(255,255,255,0.04); backdrop-filter: blur(15px);
  border: 1px solid rgba(255,100,150,0.15); border-radius: 20px;
  padding: 25px 30px; text-align: left; position: relative;
}
.story-text .cursor {
  display: inline-block; width: 2px; height: 1.2em;
  background: #ff6b9d; margin-left: 2px;
  animation: blink 0.8s step-end infinite; vertical-align: text-bottom;
}
@keyframes blink { 50% { opacity: 0; } }

.story-narrator {
  font-family: 'Dancing Script', cursive; font-size: 1em;
  color: #c4a0ff; margin-bottom: 8px; text-align: left;
  padding-left: 5px;
}

.continue-btn {
  margin-top: 25px; padding: 14px 40px; border: none; border-radius: 50px;
  font-family: 'Poppins', sans-serif; font-size: 1em; font-weight: 600;
  cursor: pointer; transition: all 0.3s;
  background: linear-gradient(135deg, #ff6b9d, #c44dff); color: white;
  box-shadow: 0 5px 25px rgba(255,107,157,0.4);
  opacity: 0; transform: translateY(10px);
}
.continue-btn.visible {
  opacity: 1; transform: translateY(0);
  transition: all 0.5s ease;
}
.continue-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 35px rgba(255,107,157,0.6); }
.continue-btn:active { transform: translateY(0); }

/* ===== Chapter title ===== */
.chapter-title {
  font-family: 'Dancing Script', cursive; font-size: 2em;
  color: #ff6b9d; margin-bottom: 5px;
  animation: fadeInUp 1s ease;
}
.chapter-sub {
  font-size: 0.85em; opacity: 0.4; margin-bottom: 20px;
  animation: fadeInUp 1s ease 0.2s both;
}
@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

/* ===== Progress dots ===== */
.chapter-dots {
  display: flex; gap: 8px; justify-content: center; margin: 20px 0;
}
.ch-dot {
  width: 10px; height: 10px; border-radius: 50%;
  background: rgba(255,255,255,0.15); transition: all 0.5s;
}
.ch-dot.active { background: #ff6b9d; box-shadow: 0 0 10px rgba(255,107,157,0.5); }
.ch-dot.done { background: #4ade80; }

/* ===== Game shared ===== */
.game-header { margin-bottom: 10px; text-align: center; }
.game-header h2 { font-family: 'Dancing Script', cursive; font-size: 1.8em; color: #ff6b9d; }
.game-stats {
  display: flex; gap: 20px; justify-content: center; margin: 10px 0; font-size: 1em;
}
.game-stats span { background: rgba(255,255,255,0.1); padding: 6px 16px; border-radius: 20px; }

/* ===== GAME 1: Memory ===== */
.game-board {
  display: grid; grid-template-columns: repeat(4,1fr); gap: 8px;
  max-width: 360px; margin: 0 auto; padding: 5px;
}
.card {
  aspect-ratio: 1; background: linear-gradient(135deg,#2d1b4e,#4a2d6e);
  border: 2px solid rgba(255,100,150,0.3); border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.8em; cursor: pointer; transition: all 0.4s;
  user-select: none; -webkit-tap-highlight-color: transparent;
}
.card:hover { border-color: rgba(255,100,150,0.6); }
.card.flipped { background: linear-gradient(135deg,#ff6b9d,#c44dff); transform: rotateY(180deg); border-color: #ff6b9d; }
.card.matched { background: linear-gradient(135deg,#4ade80,#22d3ee); border-color: #4ade80; animation: pop 0.5s ease; }
@keyframes pop { 50% { transform: scale(1.12); } }
.card .card-back { display: block; } .card .card-front { display: none; }
.card.flipped .card-back, .card.matched .card-back { display: none; }
.card.flipped .card-front, .card.matched .card-front { display: block; }

/* ===== GAME 2: Catch ===== */
.catch-area {
  position: relative; width: 100%; max-width: 380px; height: 450px;
  background: rgba(255,255,255,0.03); border: 2px solid rgba(255,100,150,0.2);
  border-radius: 20px; overflow: hidden; touch-action: none; margin: 0 auto;
}
.basket {
  position: absolute; bottom: 10px; width: 70px; height: 45px;
  font-size: 40px; text-align: center; line-height: 45px;
  transition: left 0.05s linear; user-select: none;
}
.falling-item {
  position: absolute; font-size: 28px; user-select: none; pointer-events: none;
}
.catch-bar {
  display: flex; justify-content: space-between; align-items: center;
  max-width: 380px; width: 100%; margin-bottom: 8px;
}
.catch-lives { font-size: 1.2em; }
.progress-bar {
  width: 160px; height: 10px; background: rgba(255,255,255,0.1);
  border-radius: 10px; overflow: hidden;
}
.progress-fill {
  height: 100%; background: linear-gradient(90deg, #ff6b9d, #ffd700);
  border-radius: 10px; transition: width 0.3s;
}

/* ===== GAME 3: Quiz ===== */
.quiz-box {
  max-width: 440px; width: 100%; background: rgba(255,255,255,0.05);
  backdrop-filter: blur(20px); border: 1px solid rgba(255,100,150,0.2);
  border-radius: 20px; padding: 25px 22px;
}
.quiz-question {
  margin-bottom: 20px; line-height: 1.6;
  font-family: 'Dancing Script', cursive; font-size: 1.5em;
}
.quiz-options { display: flex; flex-direction: column; gap: 10px; }
.quiz-opt {
  padding: 14px 18px; border: 2px solid rgba(255,100,150,0.3);
  border-radius: 15px; background: rgba(255,255,255,0.05);
  cursor: pointer; transition: all 0.3s; font-family: 'Poppins', sans-serif;
  font-size: 0.95em; color: #fff; text-align: left;
}
.quiz-opt:hover { border-color: #ff6b9d; background: rgba(255,100,150,0.1); }
.quiz-opt.correct { border-color: #4ade80; background: rgba(74,222,128,0.2); }
.quiz-opt.wrong { border-color: #f87171; background: rgba(248,113,113,0.2); }
.quiz-progress { margin-top: 15px; opacity: 0.5; font-size: 0.9em; }

/* ===== Win ===== */
#win { text-align: center; }
.win-content { animation: fadeInUp 1s ease; max-width: 420px; }
.win-scene { font-size: 100px; margin-bottom: 10px; }
.win-obi { display: inline-block; animation: obiJump 1s ease-in-out infinite; }
@keyframes obiJump {
  0%,100% { transform: translateY(0) rotate(-3deg); }
  50% { transform: translateY(-25px) rotate(3deg); }
}
.win-text {
  font-family: 'Dancing Script', cursive; font-size: 2.8em; margin: 15px 0;
  background: linear-gradient(90deg,#ff6b9d,#ffd700,#ff6b9d);
  background-size: 200%; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  animation: shimmer 2s ease-in-out infinite;
}
@keyframes shimmer { 0%,100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
.prize-card {
  background: rgba(255,255,255,0.08); backdrop-filter: blur(20px);
  border: 2px solid rgba(255,215,0,0.4); border-radius: 20px;
  padding: 25px; margin: 20px auto;
  animation: glowPulse 2s ease-in-out infinite;
}
@keyframes glowPulse { 0%,100% { box-shadow: 0 0 20px rgba(255,215,0,0.2); } 50% { box-shadow: 0 0 40px rgba(255,215,0,0.4); } }
.prize-card h3 { font-size: 1.4em; color: #ffd700; margin-bottom: 10px; }
.prize-card p { opacity: 0.8; line-height: 1.6; font-size: 0.95em; }

/* ===== Effects ===== */
.heart-rain {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 999; overflow: hidden;
}
.rain-heart {
  position: absolute; top: -50px;
  animation: rainFall linear forwards; font-size: 30px;
}
@keyframes rainFall {
  0% { transform: translateY(-50px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(110vh) rotate(720deg); opacity: 0.3; }
}
.sparkle {
  position: fixed; pointer-events: none; z-index: 1000;
  font-size: 16px; animation: sparkleFade 1s ease forwards;
}
@keyframes sparkleFade {
  0% { transform: scale(0) rotate(0deg); opacity: 1; }
  50% { transform: scale(1.5) rotate(180deg); opacity: 1; }
  100% { transform: scale(0) rotate(360deg); opacity: 0; }
}

/* ===== Transition overlay ===== */
.fade-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: #0a0015; z-index: 800; opacity: 0;
  pointer-events: none; transition: opacity 0.6s ease;
}
.fade-overlay.active { opacity: 1; pointer-events: all; }

@media (max-width: 500px) {
  .story-scene { font-size: 60px; }
  .story-text { font-size: 1.1em; padding: 20px; }
  .chapter-title { font-size: 1.6em; }
  .game-board { gap: 6px; max-width: 300px; }
  .card { font-size: 1.4em; border-radius: 10px; }
  .catch-area { height: 380px; }
  .win-scene { font-size: 70px; }
  .win-text { font-size: 2em; }
}
</style>
</head>
<body>

<div class="bg-hearts" id="bgHearts"></div>
<div class="fade-overlay" id="fadeOverlay"></div>

<!-- All screens rendered, JS controls flow -->
<div class="screen active" id="storyScreen">
  <div class="chapter-dots" id="chapterDots"></div>
  <div class="story-container">
    <div class="chapter-title" id="chTitle"></div>
    <div class="chapter-sub" id="chSub"></div>
    <div class="story-scene" id="storyScene"></div>
    <div class="story-narrator" id="storyNarrator"></div>
    <div class="story-text" id="storyText"></div>
    <button class="continue-btn" id="continueBtn" onclick="nextBeat()">Continue</button>
  </div>
</div>

<div class="screen" id="game1">
  <div class="game-header"><h2>Break the Spell ğŸƒ</h2></div>
  <div class="game-stats">
    <span>ğŸ¾ <span id="moves">0</span> moves</span>
    <span>â­ <span id="pairs">0</span>/8</span>
  </div>
  <div class="game-board" id="gameBoard"></div>
</div>

<div class="screen" id="game2">
  <div class="game-header"><h2>Catch the Love ğŸ’˜</h2></div>
  <div class="catch-bar">
    <div class="catch-lives" id="catchLives">â¤ï¸â¤ï¸â¤ï¸</div>
    <div class="progress-bar"><div class="progress-fill" id="catchProgress" style="width:0%"></div></div>
    <span id="catchCount" style="font-weight:600;">0/20</span>
  </div>
  <div class="catch-area" id="catchArea">
    <div class="basket" id="basket">ğŸ§º</div>
  </div>
</div>

<div class="screen" id="game3">
  <div class="game-header"><h2>The Final Lock ğŸ’Œ</h2></div>
  <div class="quiz-box">
    <div class="quiz-question" id="quizQ"></div>
    <div class="quiz-options" id="quizOpts"></div>
    <div class="quiz-progress" id="quizProg"></div>
  </div>
</div>

<div class="screen" id="win">
  <div class="win-content">
    <div class="win-scene">
      <span class="win-obi">ğŸˆâ€â¬›</span> <span>ğŸ’•</span> <span>ğŸ§¸</span>
    </div>
    <div class="win-text">I love you beb! ğŸ’•</div>
    <div class="prize-card">
      <h3>ğŸ€ Official Prize Certificate ğŸ€</h3>
      <p><strong>Obi the black cat</strong> is now yours forever! ğŸˆâ€â¬›</p>
      <p style="margin-top:8px;">Plus: one teddy bear ğŸ§¸, unlimited hugs, and a boyfriend who promises to do better ğŸ’›</p>
      <p style="margin-top:12px; font-size:0.85em; opacity:0.5;">Redeemable immediately. No expiry date. Ever.</p>
    </div>
    <button class="continue-btn visible" style="margin-top:20px;" onclick="location.reload()">Play Again ğŸ’•</button>
  </div>
</div>

<div class="heart-rain" id="heartRain"></div>

<script>
// ==================== STORY ENGINE ====================

const story = [
  // Chapter 1: The Beginning
  {
    chapter: "Chapter 1", sub: "The Beginning",
    beats: [
      { scene: "ğŸŒ™", narrator: "Narrator", text: "Once upon a time, in a cozy little apartment, there lived a black cat named Obi â€” short for Obsidian." },
      { scene: "ğŸˆâ€â¬›", narrator: "Narrator", text: "Obi had the softest fur, the brightest golden eyes, and a purr that could heal any broken heart." },
      { scene: "ğŸ’•", narrator: "Narrator", text: "He belonged to two people who loved each other very much. But one day... something went wrong." },
      { scene: "â›ˆï¸", narrator: "Narrator", text: "A storm rolled in. Not a real storm â€” the kind that happens between two hearts. Words were said. Silence followed. The apartment grew cold." },
      { scene: "ğŸˆâ€â¬›", narrator: "Obi", text: "\"I could feel it. The warmth was fading. My humans were hurting. And I... I couldn't just sit there.\"" },
      { scene: "ğŸ‘¤", narrator: "Narrator", text: "Obi did what cats do â€” he went looking for the warmth. He slipped out the window, into the night, searching for a way to fix things." },
      { scene: "ğŸ’”", narrator: "Narrator", text: "But the night was darker than he expected. And somewhere in the shadows, the Heartbreak Monster was waiting." },
      { scene: "ğŸ˜ˆ", narrator: "Heartbreak Monster", text: "\"A little cat trying to save love? How adorable. Let me show you what happens to love in my world.\"" },
      { scene: "ğŸ”’", narrator: "Narrator", text: "Three chains wrapped around Obi. Three locks clicked shut. And just like that... Obi was trapped." },
      { scene: "ğŸˆâ€â¬›", narrator: "Obi", text: "\"Please... if you're reading this... I need your help. Only someone with a loving heart can break these chains. Will you help me?\"" },
      { btn: "I'll save you, Obi ğŸ¾" },
    ]
  },
  // Chapter 2: First Lock
  {
    chapter: "Chapter 2", sub: "The Confusion Spell",
    beats: [
      { scene: "ğŸŒ«ï¸", narrator: "Narrator", text: "The first chain was made of confusion. Scattered memories, mixed-up feelings â€” everything jumbled together like a puzzle in the dark." },
      { scene: "ğŸˆâ€â¬›", narrator: "Obi", text: "\"The monster scrambled everything! I can't remember what happiness looks like anymore. Can you match the pieces back together?\"" },
      { scene: "ğŸƒ", narrator: "Narrator", text: "To break the first lock, you must find order in the chaos. Match every pair. Restore what was lost." },
      { game: 1, btn: "Break the spell ğŸƒ" },
    ]
  },
  // Chapter 2.5: After game 1
  {
    chapter: "Chapter 2", sub: "The First Chain Falls",
    beats: [
      { scene: "âœ¨", narrator: "Narrator", text: "CRACK! The first chain shattered into a thousand sparks of light. The confusion lifted like morning fog." },
      { scene: "ğŸˆâ€â¬›", narrator: "Obi", text: "\"You did it! I can feel the warmth again... just a little. But there are still two more chains. Keep going â€” please!\"" },
      { scene: "ğŸ”’ğŸ”’", narrator: "Narrator", text: "Two locks remain. The Heartbreak Monster growled in the distance. He didn't expect anyone to actually try." },
      { btn: "I'm not stopping ğŸ’ª" },
    ]
  },
  // Chapter 3: Second Lock
  {
    chapter: "Chapter 3", sub: "The Fading Hearts",
    beats: [
      { scene: "ğŸ’”", narrator: "Narrator", text: "The second chain was made of lost love. Hearts falling from the sky like rain â€” fading before they touched the ground." },
      { scene: "ğŸˆâ€â¬›", narrator: "Obi", text: "\"The monster is draining all the love from the air! You need to catch it before it disappears. But be careful â€” the broken hearts will hurt you.\"" },
      { scene: "ğŸ’˜", narrator: "Narrator", text: "Catch 20 hearts to fill Obi with enough love energy to break the second chain. Don't let the broken ones drag you down." },
      { game: 2, btn: "Catch the love ğŸ’˜" },
    ]
  },
  // Chapter 3.5: After game 2
  {
    chapter: "Chapter 3", sub: "The Second Chain Falls",
    beats: [
      { scene: "ğŸ’–", narrator: "Narrator", text: "The second chain dissolved into rose petals. Love rushed back into the air like the first breath of spring." },
      { scene: "ğŸˆâ€â¬›", narrator: "Obi", text: "\"I can almost move! One more chain... the strongest one. The monster saved his best trick for last.\"" },
      { scene: "ğŸ˜ˆ", narrator: "Heartbreak Monster", text: "\"Impressive. But the final lock isn't broken with skill. It's broken with truth. And truth... is the hardest thing of all.\"" },
      { btn: "I'm not afraid ğŸ’•" },
    ]
  },
  // Chapter 4: Final Lock
  {
    chapter: "Chapter 4", sub: "The Truth Lock",
    beats: [
      { scene: "ğŸ”®", narrator: "Narrator", text: "The final chain was made of doubt. It could only be broken by someone who understood what love really means." },
      { scene: "ğŸˆâ€â¬›", narrator: "Obi", text: "\"This is it. Answer from your heart â€” not your head. The lock can tell the difference.\"" },
      { scene: "ğŸ’Œ", narrator: "Narrator", text: "Five questions. Get four right. Prove that love isn't just a word â€” it's what you do." },
      { game: 3, btn: "Open your heart ğŸ’Œ" },
    ]
  },
  // Chapter 5: Freedom
  {
    chapter: "Chapter 5", sub: "Freedom",
    beats: [
      { scene: "ğŸ’¥", narrator: "Narrator", text: "The final chain didn't just break â€” it EXPLODED. Light poured out from every crack, flooding the darkness." },
      { scene: "ğŸ˜ˆ", narrator: "Heartbreak Monster", text: "\"No... NO! You can'tâ€” love isn't supposed to be this strong!\"" },
      { scene: "â˜€ï¸", narrator: "Narrator", text: "But it was. The monster shrank, smaller and smaller, until he was nothing but a whisper. And then... silence." },
      { scene: "ğŸˆâ€â¬›", narrator: "Obi", text: "\"I'm free. I'm really free! You saved me. You actually saved me!\"" },
      { scene: "ğŸˆâ€â¬›ğŸ’•", narrator: "Narrator", text: "Obi stretched his little legs, shook off the last traces of the chains, and purred louder than he ever had before." },
      { scene: "ğŸŒ…", narrator: "Obi", text: "\"You know why I went out into that storm? Because I believe in you two. The love between you is real. It just needed someone to fight for it.\"" },
      { scene: "ğŸˆâ€â¬›", narrator: "Obi", text: "\"So from me â€” and from someone who loves you more than you know â€” I have a message...\"" },
      { final: true },
    ]
  },
];

let currentChapter = 0;
let currentBeat = 0;
let isTyping = false;
let typeTimeout = null;
let fullText = '';

function initStory() {
  renderChapterDots();
  showBeat();
}

function renderChapterDots() {
  const dots = document.getElementById('chapterDots');
  dots.innerHTML = '';
  for (let i = 0; i < story.length; i++) {
    const d = document.createElement('div');
    d.className = 'ch-dot' + (i < currentChapter ? ' done' : '') + (i === currentChapter ? ' active' : '');
    dots.appendChild(d);
  }
}

function fadeTransition(cb) {
  const ov = document.getElementById('fadeOverlay');
  ov.classList.add('active');
  setTimeout(() => { cb(); setTimeout(() => ov.classList.remove('active'), 100); }, 600);
}

function showBeat() {
  const ch = story[currentChapter];
  if (!ch) return;
  const beat = ch.beats[currentBeat];
  if (!beat) return;

  document.getElementById('chTitle').textContent = ch.chapter;
  document.getElementById('chSub').textContent = ch.sub;
  renderChapterDots();

  const btn = document.getElementById('continueBtn');
  btn.classList.remove('visible');

  // Final beat â†’ go to win
  if (beat.final) {
    fadeTransition(() => {
      showScreen('win');
      rainHearts();
    });
    return;
  }

  // Game launch beat
  if (beat.game) {
    document.getElementById('storyScene').textContent = '';
    document.getElementById('storyNarrator').textContent = '';
    document.getElementById('storyText').innerHTML = '';
    btn.textContent = beat.btn;
    btn.classList.add('visible');
    btn.onclick = () => {
      fadeTransition(() => {
        showScreen('game' + beat.game);
        if (beat.game === 1) initMemory();
        if (beat.game === 2) initCatch();
        if (beat.game === 3) initQuiz();
      });
    };
    return;
  }

  // Regular story beat
  if (beat.scene) document.getElementById('storyScene').textContent = beat.scene;
  if (beat.narrator) document.getElementById('storyNarrator').textContent = beat.narrator === 'Narrator' ? 'ğŸ“– Narrator' : beat.narrator === 'Obi' ? 'ğŸˆâ€â¬› Obi' : 'ğŸ˜ˆ ' + beat.narrator;

  if (beat.text) {
    typeText(beat.text, () => {
      if (beat.btn) {
        btn.textContent = beat.btn;
      } else {
        btn.textContent = 'Continue âœ¨';
      }
      btn.classList.add('visible');
      btn.onclick = () => nextBeat();
    });
  } else if (beat.btn) {
    document.getElementById('storyText').innerHTML = '';
    btn.textContent = beat.btn;
    btn.classList.add('visible');
    btn.onclick = () => nextBeat();
  }
}

function typeText(text, onDone) {
  const el = document.getElementById('storyText');
  el.innerHTML = '<span class="cursor"></span>';
  fullText = text;
  isTyping = true;
  let i = 0;

  function tick() {
    if (i < text.length) {
      el.innerHTML = text.substring(0, i + 1) + '<span class="cursor"></span>';
      i++;
      const delay = text[i-1] === '.' || text[i-1] === '!' || text[i-1] === '?' ? 80 :
                    text[i-1] === ',' ? 50 : text[i-1] === '"' ? 30 : 25;
      typeTimeout = setTimeout(tick, delay);
    } else {
      isTyping = false;
      el.innerHTML = text;
      if (onDone) onDone();
    }
  }

  // Tap to skip typewriter
  el.onclick = () => {
    if (isTyping) {
      clearTimeout(typeTimeout);
      isTyping = false;
      el.innerHTML = text;
      if (onDone) onDone();
    }
  };

  tick();
}

function nextBeat() {
  const ch = story[currentChapter];
  currentBeat++;
  if (currentBeat >= ch.beats.length) {
    currentChapter++;
    currentBeat = 0;
    if (currentChapter >= story.length) return;
    fadeTransition(() => showBeat());
  } else {
    showBeat();
  }
}

function gameComplete(n) {
  fadeTransition(() => {
    showScreen('storyScreen');
    currentChapter++;
    currentBeat = 0;
    showBeat();
  });
}

// ==================== SCREENS ====================

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ==================== GAME 1: MEMORY ====================
const emojis = ['ğŸ’•','ğŸ’–','ğŸ’—','ğŸ’“','ğŸ’˜','ğŸ’','ğŸŒ¹','ğŸ’Œ'];
let memFlipped=[], memMatched=0, memMoves=0, memLocked=false;

function initMemory() {
  memMatched=0; memMoves=0; memFlipped=[]; memLocked=false;
  document.getElementById('moves').textContent='0';
  document.getElementById('pairs').textContent='0';
  const deck=[...emojis,...emojis];
  for(let i=deck.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[deck[i],deck[j]]=[deck[j],deck[i]];}
  const board=document.getElementById('gameBoard'); board.innerHTML='';
  deck.forEach((e) => {
    const c=document.createElement('div'); c.className='card';
    c.innerHTML=`<span class="card-back">ğŸ¾</span><span class="card-front">${e}</span>`;
    c.dataset.emoji=e;
    c.addEventListener('click',()=>flipCard(c));
    board.appendChild(c);
  });
}

function flipCard(card) {
  if(memLocked||card.classList.contains('flipped')||card.classList.contains('matched'))return;
  if(memFlipped.length>=2)return;
  card.classList.add('flipped'); memFlipped.push(card);
  if(memFlipped.length===2){
    memMoves++; document.getElementById('moves').textContent=memMoves; memLocked=true;
    if(memFlipped[0].dataset.emoji===memFlipped[1].dataset.emoji){
      setTimeout(()=>{
        memFlipped[0].classList.add('matched'); memFlipped[1].classList.add('matched');
        memMatched++; document.getElementById('pairs').textContent=memMatched;
        memFlipped=[]; memLocked=false;
        if(memMatched===8) setTimeout(()=>gameComplete(1),800);
      },500);
    } else {
      setTimeout(()=>{
        memFlipped[0].classList.remove('flipped'); memFlipped[1].classList.remove('flipped');
        memFlipped=[]; memLocked=false;
      },900);
    }
  }
}

// ==================== GAME 2: CATCH ====================
let catchInterval, catchLives, catchCount, catchActive=false;

function initCatch() {
  catchLives=3; catchCount=0; catchActive=true;
  document.getElementById('catchLives').textContent='â¤ï¸â¤ï¸â¤ï¸';
  document.getElementById('catchCount').textContent='0/20';
  document.getElementById('catchProgress').style.width='0%';
  const area=document.getElementById('catchArea');
  area.querySelectorAll('.falling-item').forEach(e=>e.remove());
  const basket=document.getElementById('basket');
  basket.style.left = (area.offsetWidth/2 - 35)+'px';
  area.onmousemove = (e) => { if(!catchActive) return; moveBasket(e.clientX, area); };
  area.ontouchmove = (e) => { if(!catchActive) return; e.preventDefault(); moveBasket(e.touches[0].clientX, area); };
  if(catchInterval) clearInterval(catchInterval);
  catchInterval = setInterval(() => { if(catchActive) spawnItem(area); }, 700);
}

function moveBasket(clientX, area) {
  const rect = area.getBoundingClientRect();
  let x = clientX - rect.left - 35;
  document.getElementById('basket').style.left = Math.max(0, Math.min(x, area.offsetWidth-70))+'px';
}

function spawnItem(area) {
  const isGood = Math.random() > 0.25;
  const goods = ['ğŸ’•','ğŸ’–','ğŸ’—','ğŸ’','ğŸ’˜','â¤ï¸','ğŸŒ¹'];
  const bads = ['ğŸ’”','ğŸ–¤','ğŸ‘»'];
  const item = document.createElement('div');
  item.className = 'falling-item';
  item.textContent = isGood ? goods[Math.floor(Math.random()*goods.length)] : bads[Math.floor(Math.random()*bads.length)];
  item.dataset.good = isGood ? '1' : '0';
  item.style.left = (Math.random()*(area.offsetWidth-40))+'px';
  item.style.top = '-40px';
  area.appendChild(item);
  let y = -40;
  const speed = 2 + Math.random()*2;
  (function fall() {
    if(!catchActive) { item.remove(); return; }
    y += speed; item.style.top = y+'px';
    const bx = parseFloat(document.getElementById('basket').style.left);
    const ix = parseFloat(item.style.left);
    if(y > area.offsetHeight-60 && y < area.offsetHeight-20 && Math.abs(ix-bx)<55) {
      item.remove();
      if(item.dataset.good==='1') {
        catchCount++;
        document.getElementById('catchCount').textContent=catchCount+'/20';
        document.getElementById('catchProgress').style.width=(catchCount/20*100)+'%';
        if(catchCount>=20) { endCatch(); setTimeout(()=>gameComplete(2),500); }
      } else { catchLives--; updLives(); if(catchLives<=0){endCatch();initCatch();} }
      return;
    }
    if(y>area.offsetHeight) {
      item.remove();
      if(item.dataset.good==='1') { catchLives--; updLives(); if(catchLives<=0){endCatch();initCatch();} }
      return;
    }
    requestAnimationFrame(fall);
  })();
}

function updLives() {
  document.getElementById('catchLives').textContent='â¤ï¸'.repeat(Math.max(0,catchLives))+'ğŸ¤'.repeat(Math.max(0,3-catchLives));
}
function endCatch() {
  catchActive=false;
  if(catchInterval)clearInterval(catchInterval);
  document.getElementById('catchArea').querySelectorAll('.falling-item').forEach(e=>e.remove());
}

// ==================== GAME 3: QUIZ ====================
const quizData = [
  { q: "What's the best way to say sorry?", opts: ["Text 'my bad' ğŸ’€","Buy flowers and say it in person ğŸ’","Blame the dog ğŸ•","Build her a whole website ğŸ”¥"], correct: 3 },
  { q: "When she says 'I'm fine', she means...", opts: ["She's totally fine âœ…","She is NOT fine, go fix it NOW ğŸš¨","Time to play video games ğŸ®","Ask again in 3 hours â°"], correct: 1 },
  { q: "The best gift for your girl is...", opts: ["Gift card ğŸ’³","Your time and attention ğŸ’•","A meme ğŸ˜‚","Literally anything from Shein ğŸ“¦"], correct: 1 },
  { q: "How do you win an argument?", opts: ["Raise your voice louder ğŸ“¢","Present a PowerPoint ğŸ“Š","You don't â€” you hug her ğŸ¤—","Google 'how to win argument with gf'"], correct: 2 },
  { q: "What would Obi say about love?", opts: ["Meow ğŸ±","Love is warm like a sunspot ğŸŒ","Knock things off tables as a love language ğŸ˜¼","All of the above ğŸˆâ€â¬›"], correct: 3 },
];
let quizIdx=0, quizScore=0;

function initQuiz() { quizIdx=0; quizScore=0; showQ(); }

function showQ() {
  if(quizIdx>=quizData.length) {
    if(quizScore>=4) setTimeout(()=>gameComplete(3),500);
    else { quizIdx=0; quizScore=0; showQ(); }
    return;
  }
  const q=quizData[quizIdx];
  document.getElementById('quizQ').textContent=q.q;
  document.getElementById('quizProg').textContent=`${quizIdx+1}/${quizData.length} â€¢ Score: ${quizScore} ğŸˆâ€â¬›`;
  const opts=document.getElementById('quizOpts'); opts.innerHTML='';
  q.opts.forEach((o,i) => {
    const btn=document.createElement('button'); btn.className='quiz-opt'; btn.textContent=o;
    btn.onclick=()=>{
      document.querySelectorAll('.quiz-opt').forEach((b,j)=>{
        b.style.pointerEvents='none';
        if(j===q.correct) b.classList.add('correct');
        if(j===i&&i!==q.correct) b.classList.add('wrong');
      });
      if(i===q.correct) quizScore++;
      setTimeout(()=>{quizIdx++;showQ();},1200);
    };
    opts.appendChild(btn);
  });
}

// ==================== EFFECTS ====================
function rainHearts() {
  const c=document.getElementById('heartRain'); c.innerHTML='';
  const h=['ğŸ’•','ğŸ’–','ğŸ’—','ğŸ’“','ğŸ’','ğŸ’˜','â¤ï¸','ğŸŒ¹','âœ¨','ğŸˆâ€â¬›','ğŸ¾'];
  for(let i=0;i<60;i++){
    setTimeout(()=>{
      const d=document.createElement('div'); d.className='rain-heart';
      d.textContent=h[Math.floor(Math.random()*h.length)];
      d.style.left=Math.random()*100+'%';
      d.style.fontSize=(20+Math.random()*30)+'px';
      d.style.animationDuration=(2+Math.random()*3)+'s';
      c.appendChild(d); setTimeout(()=>d.remove(),5000);
    },i*80);
  }
}

(function(){
  const c=document.getElementById('bgHearts');
  const h=['ğŸ’•','ğŸ’–','ğŸ’—','ğŸ¾','âœ¨','ğŸŒ¸'];
  for(let i=0;i<20;i++){
    const d=document.createElement('div'); d.className='bg-heart';
    d.textContent=h[Math.floor(Math.random()*h.length)];
    d.style.left=Math.random()*100+'%';
    d.style.fontSize=(14+Math.random()*18)+'px';
    d.style.animationDuration=(8+Math.random()*12)+'s';
    d.style.animationDelay=Math.random()*10+'s';
    c.appendChild(d);
  }
})();

document.addEventListener('click',e=>{
  const sp=['âœ¨','ğŸ’–','ğŸ¾'];
  for(let i=0;i<2;i++){
    const s=document.createElement('div'); s.className='sparkle';
    s.textContent=sp[Math.floor(Math.random()*sp.length)];
    s.style.left=(e.clientX+(Math.random()-0.5)*50)+'px';
    s.style.top=(e.clientY+(Math.random()-0.5)*50)+'px';
    document.body.appendChild(s); setTimeout(()=>s.remove(),1000);
  }
});

// Start
initStory();
</script>
</body>
</html>
